YUI.add("moodle-core_availability-form",function(e,t){M.core_availability=M.core_availability||{},M.core_availability.form={plugins:{},field:null,mainDiv:null,rootList:null,idCounter:0,init:function(){this.field=e.one("#id_availabilityconditionsjson"),this.field.setAttribute("aria-hidden","true"),this.mainDiv=e.Node.create('<div class="availability_field"></div>'),this.field.insert(this.mainDiv,"after");var t=this.field.get("value");if(t==="")this.rootList=new M.core_availability.List(null,!0);else{var n=e.JSON.parse(t);this.rootList=new M.core_availability.List(n,!0)}this.mainDiv.appendChild(this.rootList.node),this.mainDiv.setAttribute("aria-live","polite")},update:function(){var t=this.rootList.getValue(),n=[];this.rootList.fillErrors(n),n.length!==0&&(t.errors=n),this.field.set("value",e.JSON.stringify(t))}},M.core_availability.plugin={init:function(e){this.initBase(e)},initBase:function(e){var t=e.replace(/^availability_/,"");M.core_availability.form.plugins[t]=this},getNode:function(){throw"getNode not implemented"},fillValue:function(){throw"fillValue not implemented"},fillErrors:function(){}},M.core_availability.List=function(t,n,r){this.children=[],n!==undefined&&(this.root=n),this.node=e.Node.create('<div class="availability_list"><div class="availability_header">'+M.str.availability.listheader_sign_before+' <select class="availability_neg"><option value="">'+M.str.availability.listheader_sign_pos+"</option>"+'<option value="!">'+M.str.availability.listheader_sign_neg+"</option></select> "+'<span class="availability_single">'+M.str.availability.listheader_single+"</span>"+'<span class="availability_multi">'+M.str.availability.listheader_multi_before+' <select class="availability_op"><option value="&">'+M.str.availability.listheader_multi_and+"</option>"+'<option value="|">'+M.str.availability.listheader_multi_or+"</option></select> "+M.str.availability.listheader_multi_after+"</span></div>"+'<div class="availability_children"></div>'+'<div class="availability_none">'+M.str.moodle.none+"</div>"+'<div class="availability_button"></div></div>'),n||this.node.addClass("availability_childlist");if(n||r){console.log("Root or parent root");var i=!0;t&&t.show!==undefined&&(i=t.show),t&&t.showc!==undefined&&(i=t.showc),this.eyeIcon=new M.core_availability.EyeIcon(!1,i),this.node.one(".availability_header").get("firstChild").insert(this.eyeIcon.span,"before")}n||console.log("TODO");var s=e.Node.create('<button type="button" class="btn btn-default">'+M.str.availability.addrestriction+"</button>");s.on("click",function(){this.clickAdd()},this),this.node.one("div.availability_button").appendChild(s);if(t){switch(t.op){case"&":case"|":this.node.one(".availability_neg").set("value","");break;case"!&":case"!|":this.node.one(".availability_neg").set("value","!")}switch(t.op){case"&":case"!&":this.node.one(".availability_op").set("value","&");break;case"|":case"!|":this.node.one(".availability_op").set("value","|")}for(var o=0;o<t.c.length;o++){var u=t.c[o];this.root&&t&&t.showc!==undefined&&(u.showc=t.showc[o]);var a;u.type!==undefined?a=new M.core_availability.Item(u,this.root):a=new M.core_availability.List(u,!1,this.root),this.children.push(a),this.node.one("> .availability_children").appendChild(a.node)}this.root}this.node.one(".availability_neg").on("change",function(){M.core_availability.form.update(),this.updateHtml()},this),this.node.one(".availability_op").on("change",function(){M.core_availability.form.update(),this.updateHtml()},this),this.updateHtml()},M.core_availability.List.prototype.isIndividualShowIcons=function(){if(!this.root)throw"Can only call this on root list";var e=this.node.one(".availability_neg").get("value")==="!",t=this.node.one(".availability_op").get("value")==="|";return!e&&!t||e&&t},M.core_availability.List.prototype.updateHtml=function(){this.children.length>0?(this.node.one("> .availability_children").removeAttribute("aria-hidden"),this.node.one("> .availability_none").setAttribute("aria-hidden","true"),this.node.one("> .availability_header").removeAttribute("aria-hidden"),this.children.length>1?(this.node.one(".availability_single").setAttribute("aria-hidden","true"),this.node.one(".availability_multi").removeAttribute("aria-hidden")):(this.node.one(".availability_single").removeAttribute("aria-hidden"),this.node.one(".availability_multi").setAttribute("aria-hidden","true"))):(this.node.one("> .availability_children").setAttribute("aria-hidden","true"),this.node.one("> .availability_none").removeAttribute("aria-hidden"),this.node.one("> .availability_header").setAttribute("aria-hidden","true"));if(this.root){var e=this.isIndividualShowIcons();for(var t=0;t<this.children.length;t++){var n=this.children[t];e?n.eyeIcon.span.removeAttribute("aria-hidden"):n.eyeIcon.span.setAttribute("aria-hidden","true")}e?this.eyeIcon.span.setAttribute("aria-hidden","true"):this.eyeIcon.span.removeAttribute("aria-hidden")}},M.core_availability.List.prototype.deleteDescendant=function(e){for(var t=0;t<this.children.length;t++){var n=this.children[t];if(n===e)return this.children.splice(t,1),this.node.one("> .availability_children").removeChild(n.node),M.core_availability.form.update(),this.updateHtml(),!0;n instanceof M.core_availability.List&&n.deleteDescendant(e)}return!1},M.core_availability.List.prototype.clickAdd=function(){var t=e.Node.create('<div><ul class="list-unstyled"></ul><div class="availability-buttons"><button type="button" class="btn btn-default">'+M.str.moodle.cancel+"</button></div></div>"),n=t.one("button"),r={dialog:null},i=t.one("ul");for(var s in M.core_availability.form.plugins){var o=e.Node.create("<li></li>"),u="availability_addrestriction_"+s,a=M.str["availability_"+s],f=e.Node.create('<button type="button" class="btn btn-default"id="'+u+'">'+a.title+"</button>");f.on("click",this.getAddHandler(s,r),this),o.appendChild(f);var l=e.Node.create('<label for="'+u+'">'+a.description+"</label>");o.appendChild(l),i.appendChild(o)}var o=e.Node.create("<li></li>"),
u="availability_addrestriction_list_",f=e.Node.create('<button type="button" class="btn btn-default"id="'+u+'">'+M.str.availability.condition_group+"</button>");f.on("click",this.getAddHandler(null,r),this),o.appendChild(f);var l=e.Node.create('<label for="'+u+'">'+M.str.availability.condition_group_info+"</label>");o.appendChild(l),i.appendChild(o);var c={headerContent:M.str.availability.addrestriction,bodyContent:t,additionalBaseClass:"availability-dialogue",draggable:!0,modal:!0};r.dialog=new M.core.dialogue(c),r.dialog.show(),n.on("click",function(){r.dialog.hide()})},M.core_availability.List.prototype.getAddHandler=function(e,t){return function(){e?newItem=new M.core_availability.Item({type:e,creating:!0},this.root):newItem=new M.core_availability.List({c:[],showc:!0},!1,this.root),this.children.push(newItem),this.node.one("> .availability_children").appendChild(newItem.node),M.core_availability.form.update(),this.updateHtml(),t.dialog.hide()}},M.core_availability.List.prototype.getValue=function(){var e={};e.op=this.node.one(".availability_neg").get("value")+this.node.one(".availability_op").get("value"),e.c=[];for(var t=0;t<this.children.length;t++)e.c.push(this.children[t].getValue());if(this.root)if(this.isIndividualShowIcons()){e.showc=[];for(var t=0;t<this.children.length;t++)e.showc.push(!this.children[t].eyeIcon.isHidden())}else e.show=!this.eyeIcon.isHidden();return e},M.core_availability.List.prototype.fillErrors=function(e){this.children.length===0&&!this.root&&e.push("list_nochildren");for(var t=0;t<this.children.length;t++)this.children[t].fillErrors(e)},M.core_availability.List.prototype.eyeIcon=null,M.core_availability.List.prototype.root=!1,M.core_availability.List.prototype.children=null,M.core_availability.List.prototype.node=null,M.core_availability.Item=function(t,n){this.pluginType=t.type,M.core_availability.form.plugins[t.type]===undefined?(this.plugin=null,this.pluginNode=e.Node.create('<div class="availability_warning">'+M.str.availability.addrestriction+"</div>")):(this.plugin=M.core_availability.form.plugins[t.type],this.pluginNode=this.plugin.getNode(t)),this.node=e.Node.create('<div class="availability-item">');if(n){var r=!0;t.showc!==undefined&&(r=t.showc),this.eyeIcon=new M.core_availability.EyeIcon(!0,r),this.node.appendChild(this.eyeIcon.span)}this.pluginNode.addClass("availability-plugincontrols"),this.node.appendChild(this.pluginNode);var i=e.Node.create('<span class="availability-delete">');this.node.appendChild(i);var s=e.Node.create('<img src="'+M.cfg.wwwroot+"/theme/image.php/"+M.cfg.theme+"/core/"+M.cfg.themerev+'/t/delete" alt="'+M.str.moodle["delete"]+'" title="'+M.str.moodle["delete"]+'" tabindex="0" role="button"/>');i.appendChild(s),s.on("click",function(){M.core_availability.form.rootList.deleteDescendant(this)},this)},M.core_availability.Item.prototype.getValue=function(){return value={type:this.pluginType},this.plugin&&this.plugin.fillValue(value,this.pluginNode),value},M.core_availability.Item.prototype.fillErrors=function(e){this.plugin?this.plugin.fillErrors(e,this.pluginNode):e.push("item_unknowntype")},M.core_availability.Item.prototype.pluginType=null,M.core_availability.Item.prototype.plugin=null,M.core_availability.Item.prototype.eyeIcon=null,M.core_availability.Item.prototype.node=null,M.core_availability.Item.prototype.pluginNode=null,M.core_availability.EyeIcon=function(t,n){this.individual=t,this.span=e.Node.create('<span class="availability-eye">');var r=M.cfg.wwwroot+"/theme/image.php/"+M.cfg.theme+"/core/"+M.cfg.themerev,i=e.Node.create('<img tabindex="0" role="button"/>'),s=t?"_individual":"_all",o=function(){i.set("src",r+"/t/show"),i.set("alt",M.str.availability["hidden"+s]),i.set("title",M.str.availability["hidden"+s]+" \u2022 "+M.str.availability.show_verb)},u=function(){i.set("src",r+"/t/hide"),i.set("alt",M.str.availability["shown"+s]),i.set("title",M.str.availability["shown"+s]+" \u2022 "+M.str.availability.hide_verb)};n?u():o(),this.span.appendChild(i),i.on("click",function(){this.isHidden()?u():o(),M.core_availability.form.update()},this)},M.core_availability.EyeIcon.prototype.individual=!1,M.core_availability.EyeIcon.prototype.span=null,M.core_availability.EyeIcon.prototype.isHidden=function(){var e=this.individual?"_individual":"_all",t=M.str.availability["hidden"+e];return this.span.one("img").get("alt")===t}},"@VERSION@",{requires:["base","node","panel","moodle-core-notification-dialogue","moodle-core-actionmenu","json"]});
