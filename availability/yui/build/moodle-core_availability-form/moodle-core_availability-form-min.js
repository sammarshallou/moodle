YUI.add("moodle-core_availability-form",function(e,t){M.core_availability=M.core_availability||{},M.core_availability.form={plugins:{},field:null,mainDiv:null,rootList:null,idCounter:0,init:function(){this.field=e.one("#id_availability"),this.mainDiv=e.Node.create('<div class="availability_field"></div>'),this.field.insert(this.mainDiv,"after");var t=this.field.get("value");if(t==="")this.rootList=new M.core_availability.List(null,!0);else{var n=e.JSON.parse(t);this.rootList=new M.core_availability.List(n,!0)}this.mainDiv.appendChild(this.rootList.node)},update:function(){var t=this.rootList.getValue(),n=[];this.rootList.fillErrors(n),n.length!==0&&(t.errors=n),this.field.set("value",e.JSON.stringify(t))}},M.core_availability.plugin={init:function(e){this.initBase(e)},initBase:function(e){var t=e.replace(/^availability_/,"");M.core_availability.form.plugins[t]=this},getNode:function(e){throw"getNode not implemented"},fillValue:function(e,t){throw"fillValue not implemented"},fillErrors:function(e,t){}},M.core_availability.List=function(t,n){n!==undefined&&(this.root=n),this.node=e.Node.create('<div class="availability_list"><div class="availability_header">'+M.str.availability.listheader_sign_before+' <select class="availability_neg"><option value="">'+M.str.availability.listheader_sign_pos+"</option>"+'<option value="!">'+M.str.availability.listheader_sign_neg+"</option></select> "+'<span class="availability_single">'+M.str.availability.listheader_single+"</span>"+'<span class="availability_multi">'+M.str.availability.listheader_multi_before+' <select class="availability_op"><option value="&">'+M.str.availability.listheader_multi_and+"</option>"+'<option value="|">'+M.str.availability.listheader_multi_or+"</option></select> "+M.str.availability.listheader_multi_after+"</span></div>"+'<div class="availability_children"></div>'+'<div class="availability_none">'+M.str.moodle.none+"</div>"+'<div class="availability_button"></div></div>'),n||console.log("TODO");var r=e.Node.create('<button type="button" class="btn btn-default">'+M.str.availability.addrestriction+"</button>");r.on("click",function(){this.clickAdd()},this),this.node.one("div.availability_button").appendChild(r);if(t){switch(t.op){case"&":case"|":this.node.one(".availability_neg").set("value","");break;case"!&":case"!|":this.node.one(".availability_neg").set("value","!")}switch(t.op){case"&":case"!&":this.node.one(".availability_op").set("value","&");break;case"|":case"!|":this.node.one(".availability_op").set("value","|")}for(var i=0;i<t.c.length;i++){var s=t.c[i],o;s.type!==undefined?o=new M.core_availability.Item(s):o=new M.core_availability.List(s),this.children.push(o),this.node.one("> .availability_children").appendChild(o.node)}this.root&&console.log("TODO")}this.node.one(".availability_neg").on("valuechange",function(){M.core_availability.form.update()},this),this.node.one(".availability_op").on("valuechange",function(){M.core_availability.form.update()},this),this.updateHtml()},M.core_availability.List.prototype.updateHtml=function(){this.children.length>0?(this.node.one("> .availability_children").removeAttribute("aria-hidden"),this.node.one("> .availability_none").setAttribute("aria-hidden","true"),this.node.one("> .availability_header").removeAttribute("aria-hidden"),this.children.length>1?(this.node.one(".availability_single").setAttribute("aria-hidden","true"),this.node.one(".availability_multi").removeAttribute("aria-hidden")):(this.node.one(".availability_single").removeAttribute("aria-hidden"),this.node.one(".availability_multi").setAttribute("aria-hidden","true"))):(this.node.one("> .availability_children").setAttribute("aria-hidden","true"),this.node.one("> .availability_none").removeAttribute("aria-hidden"),this.node.one("> .availability_header").setAttribute("aria-hidden","true"))},M.core_availability.List.prototype.clickAdd=function(){var t=e.Node.create('<div><ul class="list-unstyled"></ul><div class="availability-buttons"><button type="button" class="btn btn-default">'+M.str.moodle.cancel+"</button></div></div>"),n=t.one("button"),r={dialog:null},i=t.one("ul");for(var s in M.core_availability.form.plugins){var o=e.Node.create("<li></li>"),u="availability_addrestriction_"+s,a=M.str["availability_"+s],f=e.Node.create('<button type="button" class="btn btn-default"id="'+u+'">'+a.title+"</button>");f.on("click",this.getAddHandler(s,r),this),o.appendChild(f);var l=e.Node.create('<label for="'+u+'">'+a.description+"</label>");o.appendChild(l),i.appendChild(o)}var c={headerContent:M.str.availability.addrestriction,bodyContent:t,additionalBaseClass:"availability-dialogue",draggable:!0,modal:!0};r.dialog=new M.core.dialogue(c),r.dialog.show(),n.on("click",function(){r.dialog.hide()})},M.core_availability.List.prototype.getAddHandler=function(e,t){return function(){newItem=new M.core_availability.Item({type:e,creating:!0}),this.children.push(newItem),this.node.one("> .availability_children").appendChild(newItem.node),M.core_availability.form.update(),this.updateHtml(),t.dialog.hide()}},M.core_availability.List.prototype.getValue=function(){var e={op:this.node.one(".availability_neg").get("value")+this.node.one(".availability_op").get("value")};e.c=[];for(var t=0;t<this.children.length;t++)e.c.push(this.children[t].getValue());return e},M.core_availability.List.prototype.fillErrors=function(e){this.children.length===0&&e.push("list_nochildren");for(var t=0;t<this.children.length;t++)this.children[t].fillErrors(e)},M.core_availability.List.prototype.root=!1,M.core_availability.List.prototype.children=[],M.core_availability.List.prototype.node=null,M.core_availability.Item=function(t){this.pluginType=t.type,M.core_availability.form.plugins[t.type]===undefined?(this.plugin=null,this.pluginNode=e.Node.create('<div class="availability_warning">'+M.str.availability.addrestriction+"</div>")):(this.plugin=M.core_availability.form.plugins[t.type],this.pluginNode=this.plugin.getNode(t)),this.node=e.Node.create('<div class="availability-item">'
),this.node.appendChild(this.pluginNode)},M.core_availability.Item.prototype.getValue=function(){return value={type:this.pluginType},this.plugin&&this.plugin.fillValue(value,this.pluginNode),value},M.core_availability.Item.prototype.fillErrors=function(e){this.plugin?this.plugin.fillErrors(e,this.pluginNode):e.push("item_unknowntype")},M.core_availability.Item.prototype.pluginType=null,M.core_availability.Item.prototype.plugin=null,M.core_availability.Item.prototype.node=null,M.core_availability.Item.prototype.pluginNode=null},"@VERSION@",{requires:["base","node","panel","moodle-core-notification-dialogue","moodle-core-actionmenu","json"]});
